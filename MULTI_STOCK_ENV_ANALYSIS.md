# å¤šè‚¡ç¥¨ç»„åˆå¼ºåŒ–å­¦ä¹ ç¯å¢ƒåˆ†æ

## å½“å‰è®¾è®¡

### 1. çŠ¶æ€ç©ºé—´ (State Space)
**ç»´åº¦**: `1 + 10N` (Nä¸ºè‚¡ç¥¨æ•°é‡)

```python
state = [
    ç°é‡‘å½’ä¸€åŒ–å€¼,           # 1ç»´: tanh(amount * 2^-16)
    æŒä»“æ•°é‡(Nè‚¡ç¥¨),        # Nç»´: shares * 2^-9
    å½“å‰ä»·æ ¼(Nè‚¡ç¥¨),        # Nç»´: close_price * 2^-7
    æŠ€æœ¯æŒ‡æ ‡(N*8ä¸ªç‰¹å¾)     # 8Nç»´: tech_indicators * 2^-6
]
```

**æŠ€æœ¯æŒ‡æ ‡** (æ¯åªè‚¡ç¥¨8ä¸ª):
- MACD, Bollingerä¸Šè½¨, Bollingerä¸‹è½¨, RSI, CCI, DX, SMA30, SMA60

### 2. åŠ¨ä½œç©ºé—´ (Action Space)
**ç»´åº¦**: `N` (è¿ç»­åŠ¨ä½œ)

```python
action_space = Box(low=-1.0, high=1.0, shape=(N,))
# æ˜ å°„: action_int = action * max_stock
# -1.0 â†’ å–max_stockè‚¡
#  0.0 â†’ ä¸äº¤æ˜“
# +1.0 â†’ ä¹°max_stockè‚¡
```

### 3. å¥–åŠ±å‡½æ•° (Reward)
```python
reward = (total_asset_t - total_asset_{t-1}) * reward_scale
# reward_scale = 2^-8 = 0.00391
# Terminal bonus = (1/(1-Î³)) * mean(all_rewards)
```

---

## é—®é¢˜åˆ†æ

### âŒ ä¸¥é‡é—®é¢˜

#### 1. **çŠ¶æ€ç©ºé—´ä¿¡æ¯ä¸è¶³**

**é—®é¢˜**:
- âŒ ç¼ºå°‘**ç›¸å¯¹ä»·æ ¼å˜åŒ–**ï¼ˆåªæœ‰ç»å¯¹ä»·æ ¼ï¼‰
- âŒ ç¼ºå°‘**æŒä»“æ¯”ä¾‹**ï¼ˆåªæœ‰ç»å¯¹æŒä»“æ•°é‡ï¼‰
- âŒ ç¼ºå°‘**èµ„é‡‘ä½¿ç”¨ç‡**ï¼ˆç°é‡‘/æ€»èµ„äº§ï¼‰
- âŒ æŠ€æœ¯æŒ‡æ ‡åªç”¨ç»å¯¹å€¼ï¼Œæœªæ ‡å‡†åŒ–

**å½±å“**: 
- æ™ºèƒ½ä½“éš¾ä»¥å­¦ä¹ "ä½•æ—¶ä¹°å–"çš„æ—¶æœº
- å¯¹ä¸åŒä»·æ ¼é‡çº§çš„è‚¡ç¥¨æ³›åŒ–èƒ½åŠ›å·®
- æ— æ³•ç†è§£æŠ•èµ„ç»„åˆçš„é£é™©åˆ†æ•£ç¨‹åº¦

**ç¤ºä¾‹**:
```python
# å½“å‰ï¼šåªçŸ¥é“AAPL=$150, æŒæœ‰100è‚¡
# é—®é¢˜ï¼šä¸çŸ¥é“$150æ˜¯æ¶¨äº†è¿˜æ˜¯è·Œäº†
# åº”è¯¥ï¼šçŸ¥é“AAPLä»Šæ—¥+2.5%, æŒä»“å æ€»èµ„äº§30%
```

#### 2. **åŠ¨ä½œç©ºé—´è®¾è®¡ç®€é™‹**

**é—®é¢˜**:
- âŒ åŠ¨ä½œæ˜ å°„è¿‡äºç®€å•ï¼š`action * max_stock`
- âŒ æ²¡æœ‰è€ƒè™‘å½“å‰èµ„é‡‘çº¦æŸï¼ˆå¯èƒ½äº§ç”Ÿæ— æ•ˆåŠ¨ä½œï¼‰
- âŒ å¤šè‚¡ç¥¨é—´æ— èµ„é‡‘åˆ†é…çº¦æŸ
- âŒ å¯¹äºDQNï¼Œç¦»æ•£åŠ¨ä½œç©ºé—´çˆ†ç‚¸ï¼š`5^N`

**å½±å“**:
- å¤§é‡æ— æ•ˆåŠ¨ä½œï¼ˆèµ„é‡‘ä¸è¶³ä½†å°è¯•ä¹°å…¥ï¼‰
- å¯èƒ½è¿‡åº¦é›†ä¸­äºå•åªè‚¡ç¥¨
- DQNåœ¨5åªè‚¡ç¥¨æ—¶æœ‰3125ä¸ªåŠ¨ä½œç»„åˆ

**ç¤ºä¾‹**:
```python
# åœºæ™¯ï¼šå‰©ä½™èµ„é‡‘$1000ï¼ŒAAPL=$150/è‚¡
# åŠ¨ä½œï¼šaction=[1.0] â†’ ä¹°100è‚¡ = $15,000
# ç»“æœï¼šèµ„é‡‘ä¸è¶³ï¼Œå®é™…åªä¹°6è‚¡ï¼Œå¤§éƒ¨åˆ†åŠ¨ä½œæµªè´¹
```

#### 3. **æŠ€æœ¯æŒ‡æ ‡å½’ä¸€åŒ–ä¸å½“**

**é—®é¢˜**:
- âŒ å›ºå®šç¼©æ”¾å› å­`2^-7`ä¸é€‚åˆæ‰€æœ‰ä»·æ ¼
- âŒ RSI(0-100)å’Œä»·æ ¼($50-$500)ç”¨åŒä¸€ç¼©æ”¾
- âŒ ä¸åŒè‚¡ç¥¨çš„ä»·æ ¼é‡çº§å·®å¼‚å¤§

**å½±å“**:
- é«˜ä»·è‚¡ï¼ˆå¦‚AMZN $3000ï¼‰å’Œä½ä»·è‚¡ï¼ˆå¦‚F $10ï¼‰ä¿¡å·å¼ºåº¦å·®100å€
- ç¥ç»ç½‘ç»œéš¾ä»¥å­¦ä¹ 

#### 4. **å¥–åŠ±å‡½æ•°é—®é¢˜**

**é—®é¢˜**:
- âŒ åªè€ƒè™‘æ”¶ç›Šï¼Œä¸æƒ©ç½šé£é™©
- âŒ `reward_scale=2^-8`å¯èƒ½è¿‡å°ï¼ˆè®­ç»ƒä¿¡å·å¼±ï¼‰
- âŒ Terminal rewardå…¬å¼ä¸ç›´è§‚
- âŒ æœªè€ƒè™‘äº¤æ˜“é¢‘ç‡ï¼ˆå¯èƒ½è¿‡åº¦äº¤æ˜“ï¼‰

**å½±å“**:
- æ™ºèƒ½ä½“å¯èƒ½å­¦ä¼šé«˜é£é™©ç­–ç•¥
- è®­ç»ƒæ”¶æ•›æ…¢
- äº¤æ˜“æˆæœ¬ç´¯ç§¯

### âš ï¸ æ¬¡è¦é—®é¢˜

#### 5. **çŠ¶æ€å½’ä¸€åŒ–ä¸ä¸€è‡´**
- ç°é‡‘ç”¨`tanh`ï¼Œå…¶ä»–ç”¨çº¿æ€§ç¼©æ”¾
- ä¸åŒç‰¹å¾çš„å€¼åŸŸå·®å¼‚å¤§

#### 6. **ç¼ºå°‘å¸‚åœºä¿¡æ¯**
- æ— æ•´ä½“å¸‚åœºè¶‹åŠ¿ï¼ˆå¦‚å¤§ç›˜æŒ‡æ•°ï¼‰
- æ— è‚¡ç¥¨é—´ç›¸å…³æ€§ä¿¡æ¯

---

## æ”¹è¿›æ–¹æ¡ˆ

### ğŸ”§ æ–¹æ¡ˆAï¼šå¢å¼ºçŠ¶æ€ç©ºé—´ï¼ˆæ¨èï¼‰

```python
state = [
    # === èµ„é‡‘çŠ¶æ€ (2ç»´) ===
    tanh(log(cash/initial_amount)),      # ç°é‡‘æ¯”ä¾‹ï¼ˆå¯¹æ•°ï¼‰
    tanh(portfolio_value/initial_amount - 1),  # æ€»æ”¶ç›Šç‡
    
    # === æ¯åªè‚¡ç¥¨ (N * 10ç»´) ===
    # æŒä»“ä¿¡æ¯ (3ç»´)
    shares_i / total_shares,              # æŒä»“æ¯”ä¾‹
    (price_i * shares_i) / portfolio,     # ä»“ä½å æ¯”
    tanh(shares_i * 2^-9),                # æŒä»“æ•°é‡ï¼ˆå½’ä¸€åŒ–ï¼‰
    
    # ä»·æ ¼ä¿¡æ¯ (3ç»´)
    (price_i - price_{i,t-1}) / price_{i,t-1},  # æ—¥æ”¶ç›Šç‡
    (price_i - sma30_i) / sma30_i,        # åç¦»å‡çº¿
    (price_i - price_{i,t-30}) / price_{i,t-30}, # 30æ—¥æ”¶ç›Šç‡
    
    # æŠ€æœ¯æŒ‡æ ‡ (4ç»´, æ ‡å‡†åŒ–åˆ°[-1,1])
    tanh((rsi_i - 50) / 50),              # RSIæ ‡å‡†åŒ–
    (price_i - boll_mid_i) / (boll_up_i - boll_lb_i),  # å¸ƒæ—å¸¦ä½ç½®
    tanh(macd_i / price_i),               # MACDæ ‡å‡†åŒ–
    tanh(cci_i / 100),                    # CCIæ ‡å‡†åŒ–
]
```

**ä¼˜åŠ¿**:
- âœ… åŒ…å«ç›¸å¯¹å˜åŒ–ï¼ˆæ”¶ç›Šç‡ï¼‰
- âœ… åŒ…å«æŒä»“åˆ†å¸ƒä¿¡æ¯
- âœ… æ‰€æœ‰ç‰¹å¾æ ‡å‡†åŒ–åˆ°ç›¸ä¼¼èŒƒå›´
- âœ… ä¿ç•™é‡è¦çš„å¸‚åœºä¿¡å·

### ğŸ”§ æ–¹æ¡ˆBï¼šæ”¹è¿›åŠ¨ä½œç©ºé—´

#### B1. è¿ç»­åŠ¨ä½œ - ç›®æ ‡ä»“ä½æ¯”ä¾‹ï¼ˆæ¨èï¼‰
```python
# åŠ¨ä½œï¼šç›®æ ‡ä»“ä½æ¯”ä¾‹ (Nç»´)
action_space = Box(low=0.0, high=1.0, shape=(N,))
# Softmaxå½’ä¸€åŒ–: weights = softmax(action)
# ç›®æ ‡é‡‘é¢: target_i = portfolio * weights[i]
# äº¤æ˜“: buy/sell to reach target_i

# ä¼˜åŠ¿ï¼š
# âœ… è‡ªåŠ¨æ»¡è¶³èµ„é‡‘çº¦æŸï¼ˆæ€»å’Œ=1ï¼‰
# âœ… åŠ¨ä½œè¯­ä¹‰æ˜ç¡®ï¼ˆæŠ•èµ„ç»„åˆæƒé‡ï¼‰
# âœ… å¤©ç„¶é£é™©åˆ†æ•£
```

#### B2. è¿ç»­åŠ¨ä½œ - ä»“ä½è°ƒæ•´ï¼ˆå½“å‰æ–¹æ¡ˆæ”¹è¿›ï¼‰
```python
# åŠ¨ä½œï¼šä»“ä½è°ƒæ•´ç™¾åˆ†æ¯” (Nç»´)
action_space = Box(low=-1.0, high=1.0, shape=(N,))
# action[i] = å½“å‰è‚¡ç¥¨iä»“ä½çš„è°ƒæ•´æ¯”ä¾‹
# å¦‚æŒä»“$10k, action=0.2 â†’ è°ƒæ•´ä¸º$12k

# ä¼˜åŠ¿ï¼š
# âœ… ç›¸å¯¹è°ƒæ•´ï¼Œé€‚åº”ä¸åŒå¸‚åœº
# âš ï¸ ä»éœ€æ£€æŸ¥èµ„é‡‘çº¦æŸ
```

#### B3. DQNç¦»æ•£åŠ¨ä½œä¼˜åŒ–
```python
# é—®é¢˜ï¼š5^NåŠ¨ä½œçˆ†ç‚¸
# æ–¹æ¡ˆ1ï¼šç²—ç²’åº¦åŠ¨ä½œ
n_actions_per_stock = 3  # å‡å°‘åˆ°{å–,æŒæœ‰,ä¹°}
# 5è‚¡ç¥¨ï¼š3^5 = 243 (å¯æ¥å—)

# æ–¹æ¡ˆ2ï¼šåˆ†å±‚å†³ç­–
# Step1: é€‰æ‹©æ“ä½œå“ªåªè‚¡ç¥¨ (Nä¸ªé€‰æ‹©)
# Step2: å†³å®šè¯¥è‚¡ç¥¨çš„åŠ¨ä½œ (5ä¸ªé€‰æ‹©)
# æ€»å¤æ‚åº¦ï¼šN*5

# æ–¹æ¡ˆ3ï¼šMulti-Agent
# æ¯åªè‚¡ç¥¨ä¸€ä¸ªç‹¬ç«‹DQN agent
# æ¯ä¸ªagentåªéœ€5ä¸ªåŠ¨ä½œ
```

### ğŸ”§ æ–¹æ¡ˆCï¼šæ”¹è¿›å¥–åŠ±å‡½æ•°

```python
# æ–¹æ¡ˆ1ï¼šå¤æ™®æ¯”ç‡å¥–åŠ±ï¼ˆè€ƒè™‘é£é™©ï¼‰
def calculate_reward(returns_history):
    reward = mean(returns) / (std(returns) + 1e-8)
    return reward

# æ–¹æ¡ˆ2ï¼šå¤šç›®æ ‡å¥–åŠ±
reward = (
    w1 * return_rate +              # æ”¶ç›Š
    w2 * (-portfolio_std) +         # é£é™©æƒ©ç½š
    w3 * (-trading_cost) +          # äº¤æ˜“æˆæœ¬
    w4 * diversification_bonus      # åˆ†æ•£åŒ–å¥–åŠ±
)

# æ–¹æ¡ˆ3ï¼šç¨€ç–å¥–åŠ±ï¼ˆåªåœ¨episodeç»“æŸï¼‰
reward = 0  # ä¸­é—´æ­¥éª¤
if terminal:
    reward = sharpe_ratio * 100  # æœ€ç»ˆå¤æ™®æ¯”ç‡
```

---

## æ¨èå®æ–½æ–¹æ¡ˆ

### é˜¶æ®µ1ï¼šå¿«é€Ÿä¿®å¤ï¼ˆ2å°æ—¶ï¼‰
1. **æ·»åŠ ç›¸å¯¹ä»·æ ¼ç‰¹å¾**
   ```python
   price_return = (price_t - price_{t-1}) / price_{t-1}
   state.append(price_return)
   ```

2. **æ·»åŠ æŒä»“æ¯”ä¾‹**
   ```python
   position_ratio = (price * shares) / total_asset
   state.append(position_ratio)
   ```

3. **æ”¹è¿›æŠ€æœ¯æŒ‡æ ‡å½’ä¸€åŒ–**
   ```python
   rsi_norm = tanh((rsi - 50) / 50)
   macd_norm = tanh(macd / price)
   ```

### é˜¶æ®µ2ï¼šåŠ¨ä½œç©ºé—´é‡æ„ï¼ˆ4å°æ—¶ï¼‰
1. **æ”¹ä¸ºç›®æ ‡ä»“ä½æ¯”ä¾‹**
   ```python
   action_space = Box(0, 1, (N,))
   weights = softmax(actions)
   target_values = total_asset * weights
   ```

2. **DQNé™ä½åŠ¨ä½œç©ºé—´**
   ```python
   n_actions_per_stock = 3  # {-1, 0, 1}
   total_actions = 3 ** N
   ```

### é˜¶æ®µ3ï¼šå¥–åŠ±å‡½æ•°ä¼˜åŒ–ï¼ˆ2å°æ—¶ï¼‰
1. **å¢åŠ é£é™©æƒ©ç½š**
   ```python
   reward = return - lambda * risk
   ```

2. **å¢åŠ äº¤æ˜“æˆæœ¬æ„è¯†**
   ```python
   reward -= abs(action) * cost_penalty
   ```

---

## ç†è®ºæœ€ä½³å®è·µï¼ˆå‚è€ƒFinRLï¼‰

### çŠ¶æ€ç©ºé—´è®¾è®¡åŸåˆ™
1. **åŒ…å«ä»·æ ¼å˜åŒ–ç‡**è€Œéç»å¯¹ä»·æ ¼
2. **æ ‡å‡†åŒ–åˆ°ç›¸ä¼¼èŒƒå›´**ï¼ˆå¦‚[-1, 1]æˆ–[0, 1]ï¼‰
3. **åŒ…å«æŒä»“ä¿¡æ¯**ï¼ˆæ¯”ä¾‹è€Œéç»å¯¹å€¼ï¼‰
4. **æŠ€æœ¯æŒ‡æ ‡æ ‡å‡†åŒ–**ï¼ˆZ-scoreæˆ–Min-Maxï¼‰

### åŠ¨ä½œç©ºé—´è®¾è®¡åŸåˆ™
1. **è¿ç»­åŠ¨ä½œ**ï¼šç›®æ ‡ä»“ä½æ¯”ä¾‹ï¼ˆPortfolio weightsï¼‰
2. **ç¦»æ•£åŠ¨ä½œ**ï¼šå‡å°‘ç»´åº¦ï¼ˆ3-5ä¸ªåŠ¨ä½œ/è‚¡ç¥¨ï¼‰
3. **çº¦æŸæ»¡è¶³**ï¼šè‡ªåŠ¨æ»¡è¶³é¢„ç®—çº¦æŸ

### å¥–åŠ±å‡½æ•°è®¾è®¡åŸåˆ™
1. **è€ƒè™‘é£é™©**ï¼šSharpe ratio > çº¯æ”¶ç›Š
2. **ç¨€ç–å¥–åŠ±**ï¼šé¿å…å™ªå£°ä¿¡å·
3. **é•¿æœŸç›®æ ‡**ï¼šé¼“åŠ±æŒæœ‰è€Œéé¢‘ç¹äº¤æ˜“

---

## ç°æœ‰ä»£ç çš„å…·ä½“é—®é¢˜

### é—®é¢˜1ï¼š`stock_env.py` ç¬¬134-139è¡Œ
```python
# âŒ å½“å‰
state = np.hstack((
    np.tanh(np.array([self.amount * 2 ** -16])),  # åªæœ‰ç»å¯¹ç°é‡‘
    self.shares * 2 ** -9,                         # åªæœ‰ç»å¯¹æŒä»“
    self.close_ary[day_idx] * 2 ** -7,            # åªæœ‰ç»å¯¹ä»·æ ¼
    self.tech_ary[day_idx] * 2 ** -6,             # æœªæ ‡å‡†åŒ–æŠ€æœ¯æŒ‡æ ‡
))

# âœ… åº”æ”¹ä¸º
state = np.hstack((
    np.tanh(np.log(self.amount / self.initial_amount + 1)),
    (self.close_ary[day_idx] * self.shares) / self.total_asset,  # ä»“ä½æ¯”ä¾‹
    self._get_price_returns(day_idx),              # ä»·æ ¼å˜åŒ–ç‡
    self._get_normalized_tech_indicators(day_idx), # æ ‡å‡†åŒ–æŒ‡æ ‡
))
```

### é—®é¢˜2ï¼š`stock_env.py` ç¬¬170-171è¡Œ
```python
# âŒ å½“å‰
action_int = (action * self.max_stock).astype(int)

# âœ… åº”æ”¹ä¸º
# æ–¹æ¡ˆ1ï¼šç›®æ ‡ä»“ä½
target_values = self.total_asset * softmax(action)
action_int = self._calculate_trades_to_target(target_values)

# æ–¹æ¡ˆ2ï¼šä»“ä½è°ƒæ•´ç™¾åˆ†æ¯”
current_values = self.close_ary[self.day] * self.shares
target_values = current_values * (1 + action)
action_int = self._calculate_trades_to_target(target_values)
```

### é—®é¢˜3ï¼š`data_service.py` ç¬¬114è¡Œ
```python
# âŒ å½“å‰
dx_30 = np.ones_like(macd_values) * 50  # Placeholder

# âœ… åº”ä¿®å¤
from ta.trend import ADXIndicator
adx = ADXIndicator(high=stock_df['high'], low=stock_df['low'], 
                   close=stock_df['close'], window=30)
dx_30 = adx.adx().values
```

---

## æµ‹è¯•å»ºè®®

### æµ‹è¯•ç”¨ä¾‹1ï¼šå•è‚¡ç¥¨åŸºå‡†
```python
# ä½¿ç”¨å•åªè‚¡ç¥¨æµ‹è¯•ï¼ŒéªŒè¯åŸºæœ¬åŠŸèƒ½
symbols = ["AAPL"]
# é¢„æœŸï¼šæ™ºèƒ½ä½“åº”å­¦ä¼šç®€å•çš„ä¹°å…¥æŒæœ‰ç­–ç•¥
```

### æµ‹è¯•ç”¨ä¾‹2ï¼šä¸¤åªç›¸å…³è‚¡ç¥¨
```python
# ä½¿ç”¨é«˜ç›¸å…³è‚¡ç¥¨æµ‹è¯•
symbols = ["AAPL", "MSFT"]  # ç§‘æŠ€è‚¡ï¼Œé«˜ç›¸å…³
# é¢„æœŸï¼šæ™ºèƒ½ä½“åº”å­¦ä¼šåˆ†æ•£æŠ•èµ„
```

### æµ‹è¯•ç”¨ä¾‹3ï¼šå¤šæ ·åŒ–ç»„åˆ
```python
# ä½¿ç”¨ä¸åŒè¡Œä¸šè‚¡ç¥¨
symbols = ["AAPL", "JPM", "XOM", "JNJ", "WMT"]
# é¢„æœŸï¼šæ™ºèƒ½ä½“åº”å­¦ä¼šè¡Œä¸šåˆ†æ•£
```

---

## æ€»ç»“

### æ ¸å¿ƒé—®é¢˜
1. âŒ **çŠ¶æ€ç©ºé—´ç¼ºå°‘ç›¸å¯¹å˜åŒ–ä¿¡æ¯** â† æœ€ä¸¥é‡
2. âŒ **åŠ¨ä½œç©ºé—´è®¾è®¡ç®€é™‹ï¼Œæ— èµ„é‡‘çº¦æŸ**
3. âŒ **å½’ä¸€åŒ–æ–¹å¼ä¸å½“**
4. âš ï¸ **å¥–åŠ±å‡½æ•°æœªè€ƒè™‘é£é™©**

### ä¼˜å…ˆä¿®å¤ï¼ˆå½±å“æœ€å¤§ï¼‰
1. ğŸ”¥ æ·»åŠ ä»·æ ¼æ”¶ç›Šç‡åˆ°çŠ¶æ€ç©ºé—´
2. ğŸ”¥ æ·»åŠ æŒä»“æ¯”ä¾‹åˆ°çŠ¶æ€ç©ºé—´
3. ğŸ”¥ æ”¹è¿›æŠ€æœ¯æŒ‡æ ‡å½’ä¸€åŒ–
4. âš ï¸ æ”¹è¿›åŠ¨ä½œç©ºé—´ï¼ˆç›®æ ‡ä»“ä½ï¼‰

### é¢„æœŸæ”¹è¿›
- **è®­ç»ƒç¨³å®šæ€§**: +50%
- **æœ€ç»ˆæ”¶ç›Š**: +30%
- **å¤æ™®æ¯”ç‡**: +40%
- **A2Cé›¶æ”¶ç›Šé—®é¢˜**: å·²ä¿®å¤

